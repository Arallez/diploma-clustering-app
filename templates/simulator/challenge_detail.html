{% extends 'base.html' %}

{% block title %}{{ task.title }} | –ó–∞–¥–∞—á–∏{% endblock %}

{% block extra_css %}
<style>
    /* Layout */
    .challenge-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        height: calc(100vh - 120px);
        margin: 1rem 2rem;
    }
    
    /* Left Panel */
    .task-desc {
        background: #1e293b;
        padding: 2rem;
        border-radius: 12px;
        overflow-y: auto;
        color: #e2e8f0;
        border: 1px solid #334155;
    }
    
    /* Right Panel */
    .editor-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto; /* Allow scrolling for long quizzes */
    }
    
    .code-editor {
        flex: 1;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 1rem;
        color: #f8fafc;
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 15px;
        resize: none;
        outline: none;
        line-height: 1.5;
        min-height: 300px;
    }
    .code-editor:focus {
        border-color: #3b82f6;
    }
    
    /* Quiz Styles */
    .quiz-container {
        flex: 1;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .question-block {
        border: 1px solid transparent; /* Placeholder for validation border */
        padding: 1rem;
        border-radius: 8px;
        transition: all 0.3s;
    }
    
    .question-block.wrong {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }
    
    .question-block.correct {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
    }

    .question-text {
        font-size: 1.1rem;
        margin-bottom: 1rem;
        color: #e2e8f0;
        font-weight: 600;
    }
    
    .quiz-option {
        display: block;
        background: #0f172a;
        padding: 0.8rem;
        border-radius: 8px;
        border: 1px solid #334155;
        cursor: pointer;
        transition: all 0.2s;
        color: #cbd5e1;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .quiz-option:hover {
        border-color: #3b82f6;
        background: #1e293b;
    }
    
    .quiz-option input[type="radio"] {
        margin-right: 10px;
        transform: scale(1.1);
    }
    
    .quiz-option.selected {
        border-color: #3b82f6;
        background: #1e293b;
        box-shadow: 0 0 0 1px #3b82f6;
        color: #fff;
    }

    /* Buttons */
    .actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .btn {
        padding: 0.7rem 1.4rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
    }
    
    .btn-primary {
        background: #2563eb;
        color: white;
    }
    .btn-primary:hover { background: #1d4ed8; }
    
    .btn-secondary {
        background: #334155;
        color: #e2e8f0;
    }
    .btn-secondary:hover { background: #475569; }
    
    .btn-danger {
        background: #b91c1c;
        color: white;
    }
    .btn-danger:hover { background: #991b1b; }
    
    /* Back Link */
    .back-link {
        display: inline-block;
        margin-bottom: 1.5rem;
        color: #94a3b8;
        text-decoration: none;
        font-weight: 500;
        padding: 0.4rem 0.8rem;
        background: #0f172a;
        border-radius: 6px;
        border: 1px solid #334155;
        transition: all 0.2s;
    }
    .back-link:hover {
        color: #f1f5f9;
        border-color: #475569;
        background: #1e293b;
    }

    /* Badges */
    .badge-row {
        display: flex;
        gap: 0.8rem;
        margin-top: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .difficulty-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    .level-1 { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .level-2 { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .level-3 { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    
    .algo-tag {
        background: #0f172a;
        color: #94a3b8;
        padding: 0.3rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        border: 1px solid #334155;
    }

    /* Result Box */
    .result-box {
        margin-top: 0;
        padding: 1rem;
        border-radius: 8px;
        display: none; /* Hidden by default */
        font-family: sans-serif;
        line-height: 1.5;
    }
    
    .result-box.success {
        display: block;
        background: #064e3b;
        color: #a7f3d0;
        border: 1px solid #059669;
    }
    
    .result-box.error {
        display: block;
        background: #450a0a;
        color: #fca5a5;
        border: 1px solid #b91c1c;
    }

    /* --- Custom Modal --- */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(2px);
    }
    .modal-content {
        background: #1e293b;
        border: 1px solid #334155;
        padding: 2rem;
        border-radius: 12px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .modal-title { font-size: 1.25rem; font-weight: bold; color: #f1f5f9; margin-bottom: 0.5rem; }
    .modal-text { color: #94a3b8; margin-bottom: 1.5rem; line-height: 1.5; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }

    /* --- Custom Toast --- */
    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: #b91c1c;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        animation: slideIn 0.3s ease-out;
        max-width: 350px;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Navbar Fix */
    header .btn-outline, .navbar .btn-outline {
        border: 1px solid #475569 !important;
        padding: 0.5rem 1rem !important;
        border-radius: 6px !important;
        color: #e2e8f0 !important;
        text-decoration: none !important;
    }
    header .btn-outline:hover, .navbar .btn-outline:hover {
        background-color: #334155 !important;
        color: #fff !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="challenge-layout">
    <!-- Left: Task Description -->
    <div class="task-desc">
        <a href="{% url 'simulator:task_list' %}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        
        <h1 style="margin: 0; font-size: 1.8rem; color: #f1f5f9;">{{ task.title }}</h1>
        
        <div class="badge-row">
            <span class="difficulty-badge level-{{ task.difficulty }}">
                {% if task.difficulty == 1 %}Easy
                {% elif task.difficulty == 2 %}Medium
                {% else %}Hard{% endif %}
            </span>
            {% if task.tags %}
                <span class="algo-tag">{{ task.tags.name }}</span>
            {% endif %}
            <span class="algo-tag" style="background: #334155; color: white;">
                {% if task.task_type == 'code' %}üíª –ö–æ–¥{% else %}üìù –¢–µ—Å—Ç{% endif %}
            </span>
        </div>
        
        <div class="description-content" style="margin-top: 1.5rem; line-height: 1.7;">
            {{ task.description|safe }}
        </div>
        
        {% if task.task_type == 'code' %}
        <div class="examples" style="margin-top: 2rem;">
            <h3 style="color: #cbd5e1;">–ü—Ä–∏–º–µ—Ä:</h3>
            <pre style="background: #0f172a; padding: 1rem; border-radius: 6px; color: #e2e8f0; overflow-x: auto;"><code>Input: {{ task.test_input }}
Output: {{ task.expected_output }}</code></pre>
        </div>
        {% endif %}
    </div>

    <!-- Right: Interface (Code or Choice) -->
    <div class="editor-container">
        
        {% if task.task_type == 'code' %}
            <!-- Code Editor Mode -->
            <textarea id="code-editor" class="code-editor" spellcheck="false" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ –∑–¥–µ—Å—å...">{{ previous_code }}</textarea>
        {% else %}
            <!-- Quiz Mode -->
            <div class="quiz-container">
                <form id="quiz-form">
                    
                    {% if task.test_input.questions %}
                        <!-- MULTI QUESTION MODE -->
                        {% for question in task.test_input.questions %}
                        <div class="question-block" id="q-block-{{ forloop.counter0 }}">
                            <div class="question-text">{{ question.text|safe }}</div>
                            {% for option in question.options %}
                            <label class="quiz-option">
                                <input type="radio" name="quiz_answer_{{ forloop.parentloop.counter0 }}" value="{{ option }}">
                                {{ option }}
                            </label>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    
                    {% else %}
                        <!-- SINGLE QUESTION MODE (Legacy) -->
                        <h3 style="color: #e2e8f0; margin-top: 0;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</h3>
                        {% for option in task.test_input.options %}
                        <label class="quiz-option">
                            <input type="radio" name="quiz_answer" value="{{ option }}">
                            {{ option }}
                        </label>
                        {% endfor %}
                    {% endif %}

                </form>
            </div>
        {% endif %}
        
        <div id="result-box" class="result-box"></div>

        <div class="actions">
            {% if task.task_type == 'code' %}
                <button class="btn btn-secondary" onclick="openResetModal()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            {% endif %}
            <button class="btn btn-primary" onclick="submitSolution()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ ‚ñ∂</button>
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="custom-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-title">‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ?</div>
        <div class="modal-text">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∫–æ–¥ –∏ –≤–µ—Ä–Ω—É—Ç—å –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" onclick="confirmReset()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Custom Toast Notification -->
<div id="custom-toast" class="toast" style="display: none;">
    <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
    <span id="toast-message">–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const taskType = '{{ task.task_type }}';
    
    // Highlight selected radio buttons
    if (taskType === 'choice') {
        document.addEventListener('change', function(e) {
            if(e.target.matches('.quiz-option input[type="radio"]')) {
                const groupName = e.target.name;
                document.querySelectorAll(`input[name="${groupName}"]`).forEach(inp => {
                    inp.closest('.quiz-option').classList.remove('selected');
                });
                e.target.closest('.quiz-option').classList.add('selected');
            }
        });
    }

    // --- Custom UI Functions ---
    function openResetModal() {
        document.getElementById('custom-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('custom-modal').style.display = 'none';
    }

    function confirmReset() {
        const initialCode = `{{ task.initial_code|escapejs }}`;
        document.getElementById('code-editor').value = initialCode;
        document.getElementById('result-box').style.display = 'none';
        closeModal();
    }

    function showToast(message) {
        const toast = document.getElementById('custom-toast');
        const msgEl = document.getElementById('toast-message');
        msgEl.textContent = message;
        toast.style.display = 'flex';
        
        // Hide after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                toast.style.display = 'none';
                toast.style.opacity = '1';
            }, 300);
        }, 3000);
    }

    // Close modal on click outside
    window.onclick = function(event) {
        const modal = document.getElementById('custom-modal');
        if (event.target == modal) {
            closeModal();
        }
    }

    async function submitSolution() {
        const resultBox = document.getElementById('result-box');
        let payload = { slug: '{{ task.slug }}' };
        
        // Reset previous validation styles
        document.querySelectorAll('.question-block').forEach(el => {
            el.classList.remove('correct', 'wrong');
        });

        if (taskType === 'code') {
            payload.code = document.getElementById('code-editor').value;
        } else {
            // Check for multi-questions
            const questions = document.querySelectorAll('.question-block');
            
            if (questions.length > 0) {
                let answers = [];
                let allAnswered = true;
                
                questions.forEach((q, index) => {
                    const selected = q.querySelector(`input[name="quiz_answer_${index}"]:checked`);
                    if (selected) {
                        answers.push(selected.value);
                    } else {
                        allAnswered = false;
                    }
                });
                
                if (!allAnswered) {
                    showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã.');
                    return;
                }
                payload.code = answers; 
                
            } else {
                // Single Answer
                const selected = document.querySelector('input[name="quiz_answer"]:checked');
                if (!selected) {
                    showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.');
                    return;
                }
                payload.code = selected.value;
            }
        }
        
        // Show loading state
        resultBox.style.display = 'block';
        resultBox.className = 'result-box';
        resultBox.style.background = '#1e293b';
        resultBox.style.color = '#94a3b8';
        resultBox.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        
        try {
            const response = await fetch('/simulator/api/check-solution/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            
            // Handle per-question feedback
            if (data.quiz_results) {
                data.quiz_results.forEach((isCorrect, index) => {
                    const block = document.getElementById(`q-block-${index}`);
                    if (block) {
                        if (isCorrect) {
                            block.classList.add('correct');
                        } else {
                            block.classList.add('wrong');
                        }
                    }
                });
            }

            if (data.success) {
                resultBox.className = 'result-box success';
                resultBox.style.display = 'block'; 
                resultBox.innerHTML = '‚úÖ <b>–í–µ—Ä–Ω–æ!</b> ' + (data.message || '');
            } else {
                resultBox.className = 'result-box error';
                resultBox.style.display = 'block'; 
                resultBox.innerHTML = '‚ùå <b>–û—à–∏–±–∫–∞:</b> ' + (data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç');
            }
        } catch (e) {
            console.error(e);
            resultBox.className = 'result-box error';
            resultBox.style.display = 'block'; 
            resultBox.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
        }
    }
</script>
{% endblock %}
