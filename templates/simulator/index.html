{% extends 'base.html' %}
{% load static %}

{% block title %}–°–∏–º—É–ª—è—Ç–æ—Ä –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏{% endblock %}

{% block extra_css %}
<!-- Added version parameter to force cache refresh -->
<link rel="stylesheet" href="{% static 'css/simulator.css' %}?v=3.5">
{% endblock %}

{% block content %}
<!-- Vue App Wrapper -->
{% verbatim %}
<div id="app" v-cloak>
    
    <div class="layout">
        <!-- Sidebar Controls -->
        <aside class="sidebar">
            <div class="control-group">
                <span class="control-label">–ê–ª–≥–æ—Ä–∏—Ç–º</span>
                <select class="cluster-input full-width" v-model="algorithm">
                    <option value="kmeans">K-Means (–ö-–°—Ä–µ–¥–Ω–∏—Ö)</option>
                    <option value="dbscan">DBSCAN</option>
                    <option value="forel">FOREL (–§–û–†–≠–õ–¨) ‚≠ê</option>
                    <option value="agglomerative">–ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è (Agglomerative)</option>
                    <option value="meanshift">MeanShift (–°–¥–≤–∏–≥ —Å—Ä–µ–¥–Ω–µ–≥–æ)</option>
                </select>
            </div>

            <!-- Dataset Presets -->
            <div class="control-group">
                <span class="control-label">üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—Ç–∞—Å–µ—Ç</span>
                <select class="cluster-input full-width" v-model="selectedPreset">
                    <option value="" selected>–í—Ä—É—á–Ω—É—é (–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)</option>
                    <option value="moons">üåô –õ—É–Ω—ã (Demo DBSCAN)</option>
                    <option value="circles">‚≠ï –ö–æ–ª—å—Ü–∞ (–í–ª–æ–∂–µ–Ω–Ω—ã–µ)</option>
                    <option value="blobs">üîµ –ü—è—Ç–Ω–∞ (Demo K-Means)</option>
                    <option value="grid">üü¶ –°–µ—Ç–∫–∞ (–†–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è)</option>
                    <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                    <option value="hierarchy">üß¨ –ò–µ—Ä–∞—Ä—Ö–∏—è (–î–ª—è Agglomerative)</option>
                    <option value="dense_sparse">üå´ –ü–ª–æ—Ç–Ω–æ—Å—Ç—å (–î–ª—è FOREL/DBSCAN)</option>
                </select>
            </div>

            <!-- Controls for K-Means -->
            <div class="control-group" v-if="algorithm === 'kmeans'">
                <span class="control-label">–ß–∏—Å–ª–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (K)</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="k > 1 ? k-- : null">-</button>
                    <input type="number" v-model="k" class="cluster-input" min="1" max="10">
                    <button class="btn btn-outline" @click="k < 10 ? k++ : null">+</button>
                </div>
            </div>

            <!-- Controls for DBSCAN -->
            <div class="control-group" v-if="algorithm === 'dbscan'">
                <span class="control-label">–†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ (Epsilon)</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="eps = Math.max(0.1, (parseFloat(eps) - 0.1).toFixed(1))">-</button>
                    <input type="number" v-model.number="eps" class="cluster-input" step="0.1" min="0.1" max="5.0">
                    <button class="btn btn-outline" @click="eps = Math.min(5.0, (parseFloat(eps) + 0.1).toFixed(1))">+</button>
                </div>
            </div>

            <div class="control-group" v-if="algorithm === 'dbscan'">
                <span class="control-label">–ú–∏–Ω. —Å–æ—Å–µ–¥–µ–π (MinPts)</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="minPts > 1 ? minPts-- : null">-</button>
                    <input type="number" v-model="minPts" class="cluster-input" min="1" max="20">
                    <button class="btn btn-outline" @click="minPts < 20 ? minPts++ : null">+</button>
                </div>
            </div>

            <!-- Controls for FOREL -->
            <div class="control-group" v-if="algorithm === 'forel'">
                <span class="control-label">–†–∞–¥–∏—É—Å —Å—Ñ–µ—Ä—ã (R)</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="radius = Math.max(0.1, ((parseFloat(radius) || 1.0) - 0.1).toFixed(1))">-</button>
                    <input type="number" v-model.number="radius" class="cluster-input" step="0.1" min="0.1" max="5.0">
                    <button class="btn btn-outline" @click="radius = Math.min(5.0, ((parseFloat(radius) || 1.0) + 0.1).toFixed(1))">+</button>
                </div>
            </div>

            <!-- Controls for Agglomerative -->
            <div class="control-group" v-if="algorithm === 'agglomerative'">
                <span class="control-label">–¶–µ–ª–µ–≤—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="k > 1 ? k-- : null">-</button>
                    <input type="number" v-model="k" class="cluster-input" min="2" max="10">
                    <button class="btn btn-outline" @click="k < 10 ? k++ : null">+</button>
                </div>
            </div>

             <!-- Controls for MeanShift -->
            <div class="control-group" v-if="algorithm === 'meanshift'">
                <span class="control-label">Bandwidth (–®–∏—Ä–∏–Ω–∞ –æ–∫–Ω–∞)</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="bandwidth = Math.max(0.1, ((parseFloat(bandwidth) || 1.0) - 0.1).toFixed(1))">-</button>
                    <input type="number" v-model.number="bandwidth" class="cluster-input" step="0.1" min="0.1" max="5.0">
                    <button class="btn btn-outline" @click="bandwidth = Math.min(5.0, ((parseFloat(bandwidth) || 1.0) + 0.1).toFixed(1))">+</button>
                </div>
            </div>

            <div class="control-group" style="margin-top: 0.5rem;">
                <button class="btn btn-outline" @click="clearPoints" style="margin-bottom: 0.25rem; width: 100%;">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>
                <button class="btn" @click="runAlgorithm" :disabled="points.length === 0 || isRunning" style="width: 100%;">
                    {{ isRunning ? '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å' }}
                </button>
                
                <!-- Dendrogram button for Agglomerative -->
                <button v-if="algorithm === 'agglomerative'" class="btn btn-secondary" @click="viewDendrogram" :disabled="points.length < 2 || isRunning" style="width: 100%; margin-top: 0.25rem;">
                    üå≥ –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–Ω–¥—Ä–æ–≥—Ä–∞–º–º—É
                </button>
            </div>

            <div class="help-box">
                <div v-if="algorithm === 'kmeans'">
                    <strong>üí° K-Means:</strong> –í—ã–±–µ—Ä–∏—Ç–µ K. –ê–ª–≥–æ—Ä–∏—Ç–º –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ –∏—â–µ—Ç —Ü–µ–Ω—Ç—Ä—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.
                </div>
                <div v-else-if="algorithm === 'dbscan'">
                    <strong>üí° DBSCAN:</strong> –ü–æ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏. –¢–æ—á–∫–∏ –≤ —Ä–∞–¥–∏—É—Å–µ Eps —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —è–¥—Ä–æ–º, –µ—Å–ª–∏ —Å–æ—Å–µ–¥–µ–π >= MinPts.
                </div>
                <div v-else-if="algorithm === 'forel'">
                    <strong>üí° FOREL:</strong> –°–æ–≤–µ—Ç—Å–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º. –°—Ñ–µ—Ä–∞ —Ä–∞–¥–∏—É—Å–∞ R –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä –º–∞—Å—Å —Å–æ—Å–µ–¥–µ–π.
                </div>
                <div v-else-if="algorithm === 'agglomerative'">
                    <strong>üí° –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è:</strong> –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –±–ª–∏–∂–∞–π—à–∏–µ –∫–ª–∞—Å—Ç–µ—Ä—ã —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞.
                </div>
                <div v-else-if="algorithm === 'meanshift'">
                    <strong>üí° MeanShift:</strong> –ò—â–µ—Ç "–º–æ–¥—ã" –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏. –û–∫–Ω–æ —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è –∫ —Å—Ä–µ–¥–Ω–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é —Å–æ—Å–µ–¥–µ–π.
                </div>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="workspace">
            
            <!-- Info Chips -->
            <div class="stats-bar">
                <div class="stat-chip">–¢–æ—á–∫–∏: <span class="stat-value">{{ points.length }}</span></div>
                <div class="stat-chip" v-if="algorithm === 'kmeans' || algorithm === 'agglomerative'">K: <span class="stat-value">{{ k }}</span></div>
                <div class="stat-chip" v-else-if="algorithm === 'forel'">R: <span class="stat-value">{{ radius }}</span></div>
                <div class="stat-chip" v-else-if="algorithm === 'meanshift'">BW: <span class="stat-value">{{ bandwidth }}</span></div>
                <div class="stat-chip" v-else>Eps: <span class="stat-value">{{ eps }}</span></div>
                <div class="stat-chip">–®–∞–≥–∏: <span class="stat-value">{{ history.length ? history.length : 0 }}</span></div>
            </div>

            <!-- Visualization -->
            <div class="graph-card">
                <div id="plot" @click="handleCanvasClick"></div>
            </div>

            <!-- Step Player -->
            <transition name="fade">
                <div class="step-control" v-if="history.length > 0">
                    <button class="btn btn-outline" @click="setStep(0)">‚èÆ</button>
                    <button class="btn btn-outline" @click="prevStep">‚óÄ</button>
                    
                    <div class="slider-container">
                        <span class="step-label align-right">{{ currentStep }}</span>
                        <input type="range" min="0" :max="history.length - 1" v-model.number="currentStep">
                        <span class="step-label">{{ history.length - 1 }}</span>
                    </div>

                    <button class="btn btn-outline" @click="nextStep">‚ñ∂</button>
                    <button class="btn btn-outline" @click="setStep(history.length - 1)">‚è≠</button>
                </div>
            </transition>

        </main>
    </div>

    <!-- Dendrogram Modal -->
    <transition name="fade">
        <div v-if="showDendrogram" class="modal-overlay" @click="closeDendrogram">
            <div class="modal-content" @click.stop>
                <button class="modal-close" @click="closeDendrogram">√ó</button>
                <div id="dendrogram-plot" style="width: 100%; height: 500px;"></div>
            </div>
        </div>
    </transition>

</div>
{% endverbatim %}
{% endblock %}

{% block extra_js %}
<!-- Local Vendors (Faster, Offline) -->
<script src="{% static 'js/vendor/plotly.min.js' %}"></script>
<script src="{% static 'js/vendor/vue.global.js' %}"></script>

<!-- Main App (BUMPED VERSION TO v=5.0 TO FIX CACHING) -->
<script type="module" src="{% static 'js/simulator/app.js' %}?v=5.0"></script>
{% endblock %}
