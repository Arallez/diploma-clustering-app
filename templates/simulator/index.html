{% extends 'base.html' %}

{% block title %}Clustering Simulator{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/simulator.css">
{% endblock %}

{% block content %}
<!-- Vue App Wrapper -->
{% verbatim %}
<div id="app">
    
    <div class="simulator-container">
        <!-- Sidebar Controls -->
        <aside class="sidebar">
            <div class="controls-section">
                <div class="control-group">
                    <label class="control-label">Algorithm</label>
                    <select class="control-select" v-model="algorithm">
                        <option value="kmeans">K-Means Clustering</option>
                        <option value="dbscan">DBSCAN</option>
                        <option value="forel">FOREL (Soviet) ‚≠ê</option>
                        <option value="agglomerative">Hierarchical (Agglomerative)</option>
                    </select>
                </div>

                <!-- Dataset Presets -->
                <div class="control-group">
                    <label class="control-label">üìä Load Dataset</label>
                    <select class="control-select" v-model="selectedPreset">
                        <option value="" selected>Manual (click to add)</option>
                        <option value="moons">üåô Moons (DBSCAN demo)</option>
                        <option value="circles">‚≠ï Circles (nested)</option>
                        <option value="blobs">üîµ Blobs (K-Means demo)</option>
                        <option value="grid">üü¶ Grid (uniform)</option>
                    </select>
                </div>

                <!-- Controls for K-Means -->
                <div class="control-group" v-if="algorithm === 'kmeans'">
                    <label class="control-label">Clusters (K)</label>
                    <div class="step-controls">
                        <button class="btn-step" @click="k > 1 ? k-- : null">-</button>
                        <input type="number" v-model="k" class="control-input" min="1" max="10" style="text-align: center">
                        <button class="btn-step" @click="k < 10 ? k++ : null">+</button>
                    </div>
                </div>

                <!-- Controls for DBSCAN -->
                <div class="control-group" v-if="algorithm === 'dbscan'">
                    <label class="control-label">Epsilon (Radius)</label>
                    <div class="step-controls">
                        <button class="btn-step" @click="eps = Math.max(0.1, (parseFloat(eps) - 0.1).toFixed(1))">-</button>
                        <input type="number" v-model.number="eps" class="control-input" step="0.1" min="0.1" max="5.0" style="text-align: center">
                        <button class="btn-step" @click="eps = Math.min(5.0, (parseFloat(eps) + 0.1).toFixed(1))">+</button>
                    </div>
                </div>

                <div class="control-group" v-if="algorithm === 'dbscan'">
                    <label class="control-label">Min Points</label>
                    <div class="step-controls">
                        <button class="btn-step" @click="minPts > 1 ? minPts-- : null">-</button>
                        <input type="number" v-model="minPts" class="control-input" min="1" max="20" style="text-align: center">
                        <button class="btn-step" @click="minPts < 20 ? minPts++ : null">+</button>
                    </div>
                </div>

                <!-- Controls for FOREL -->
                <div class="control-group" v-if="algorithm === 'forel'">
                    <label class="control-label">Sphere Radius (R)</label>
                    <div class="step-controls">
                        <button class="btn-step" @click="radius = Math.max(0.1, (parseFloat(radius) - 0.1).toFixed(1))">-</button>
                        <input type="number" v-model.number="radius" class="control-input" step="0.1" min="0.1" max="5.0" style="text-align: center">
                        <button class="btn-step" @click="radius = Math.min(5.0, (parseFloat(radius) + 0.1).toFixed(1))">+</button>
                    </div>
                </div>

                <!-- Controls for Agglomerative -->
                <div class="control-group" v-if="algorithm === 'agglomerative'">
                    <label class="control-label">Clusters (N)</label>
                    <div class="step-controls">
                        <button class="btn-step" @click="k > 1 ? k-- : null">-</button>
                        <input type="number" v-model="k" class="control-input" min="2" max="10" style="text-align: center">
                        <button class="btn-step" @click="k < 10 ? k++ : null">+</button>
                    </div>
                </div>

                <div class="control-group" style="margin-top: 1rem;">
                    <button class="btn-danger" @click="clearPoints">Clear Board</button>
                    <button class="btn-primary" @click="runAlgorithm" :disabled="points.length === 0 || isRunning" style="margin-top: 0.5rem;">
                        {{ isRunning ? 'Processing...' : 'Run Algorithm' }}
                    </button>
                </div>
            </div>

            <div class="help-text">
                <div v-if="algorithm === 'kmeans'">
                    <strong>üí° K-Means:</strong> Select K clusters. Algorithm finds centroids iteratively.
                </div>
                <div v-else-if="algorithm === 'dbscan'">
                    <strong>üí° DBSCAN:</strong> Density-based. Points within Eps become core if neighbors >= MinPts.
                </div>
                <div v-else-if="algorithm === 'forel'">
                    <strong>üí° FOREL:</strong> Place random sphere, move to center of mass, remove points, repeat.
                </div>
                <div v-else-if="algorithm === 'agglomerative'">
                    <strong>üí° Hierarchical:</strong> Bottom-up approach. Merges closest clusters until N remain.
                </div>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="main-area">
            
            <!-- Visualization -->
            <div class="canvas-container">
                <div id="plot" @click="handleCanvasClick" style="width: 100%; height: 100%;"></div>
                
                <!-- Overlay Stats -->
                <div class="stats-overlay">
                    <div>Points: {{ points.length }}</div>
                    <div v-if="algorithm === 'kmeans' || algorithm === 'agglomerative'">K: {{ k }}</div>
                    <div v-else-if="algorithm === 'forel'">R: {{ radius }}</div>
                    <div v-else>Eps: {{ eps }} | MinPts: {{ minPts }}</div>
                    <div>Steps: {{ history.length ? history.length : 0 }}</div>
                </div>
            </div>

            <!-- Step Player -->
            <div class="controls-section" v-if="history.length > 0" style="margin-top: 1rem; padding: 0.5rem;">
                <div class="step-controls" style="align-items: center;">
                    <button class="btn-step" @click="setStep(0)">‚èÆ</button>
                    <button class="btn-step" @click="prevStep">‚óÄ</button>
                    
                    <div style="flex: 2; display: flex; align-items: center; padding: 0 1rem;">
                        <span style="font-size: 0.8rem; margin-right: 0.5rem; color: #94a3b8;">{{ currentStep }}</span>
                        <input type="range" min="0" :max="history.length - 1" v-model.number="currentStep" class="history-slider">
                        <span style="font-size: 0.8rem; margin-left: 0.5rem; color: #94a3b8;">{{ history.length - 1 }}</span>
                    </div>

                    <button class="btn-step" @click="nextStep">‚ñ∂</button>
                    <button class="btn-step" @click="setStep(history.length - 1)">‚è≠</button>
                </div>
            </div>

        </main>
    </div>

</div>
{% endverbatim %}
{% endblock %}

{% block extra_js %}
<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<!-- Vue.js 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<!-- New Modular Architecture -->
<script type="module" src="/static/js/simulator/app.js"></script>
{% endblock %}
