{% extends 'base.html' %}
{% load static %}

{% block title %}{{ task.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tasks.css' %}?v=1.2">
<style>
    .challenge-container {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 20px;
        height: calc(100vh - 100px);
    }
    .task-sidebar {
        background: rgba(30, 41, 59, 0.5);
        border-right: 1px solid #334155;
        padding: 20px;
        overflow-y: auto;
    }
    .editor-area {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    #monaco-editor {
        flex: 1;
        border: 1px solid #334155;
    }
    .output-panel {
        height: 150px;
        background: #0f172a;
        border-top: 1px solid #334155;
        padding: 10px;
        font-family: 'Fira Code', monospace;
        font-size: 0.9rem;
        overflow-y: auto;
        color: #94a3b8;
    }
    .output-success { color: #4ade80; }
    .output-error { color: #f87171; }
    
    .run-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .run-btn:disabled {
        background: #64748b;
        cursor: wait;
    }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper" style="padding: 20px;">
    <div class="challenge-container">
        <!-- Sidebar: Task Description -->
        <div class="task-sidebar">
            <a href="{% url 'simulator:task_list' %}" style="color: #94a3b8; text-decoration: none; margin-bottom: 20px; display: block;">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
            
            <h1 style="font-size: 1.5rem; margin-bottom: 10px; color: #fff;">{{ task.title }}</h1>
            
            <div class="task-badge difficulty-{{ task.difficulty }}">
                {% if task.difficulty == 1 %}Novice{% elif task.difficulty == 2 %}Beginner{% else %}Hard{% endif %}
            </div>

            <div class="markdown-body" style="font-size: 0.95rem; line-height: 1.6; color: #e2e8f0; margin-top: 20px;">
                {{ task.description|safe }}
            </div>

            {% if task.task_type == 'code' %}
            <div style="margin-top: 20px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.2);">
                <strong style="color: #60a5fa;">–ó–∞–¥–∞—á–∞:</strong><br>
                –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é <code>{{ task.function_name }}</code>.
            </div>
            {% endif %}
        </div>

        <!-- Main: Editor -->
        <div class="editor-area">
            <div id="monaco-editor"></div>
            
            <div class="controls" style="padding: 10px; background: #1e293b; display: flex; align-items: center; justify-content: space-between;">
                <span style="color: #64748b; font-size: 0.8rem;">Python 3.11 (Pyodide Client-Side)</span>
                <button id="runBtn" class="run-btn" onclick="runCode()">
                    <div class="spinner" id="spinner"></div>
                    <span id="btnText">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</span>
                </button>
            </div>

            <div id="output" class="output-panel">
                –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JS -->
<input type="hidden" id="initial-code" value="{{ previous_code|escape }}">
<input type="hidden" id="task-slug" value="{{ task.slug }}">
<input type="hidden" id="function-name" value="{{ task.function_name }}">
<!-- We need expected output and test input in JSON format for client-side check -->
<input type="hidden" id="test-input" value="{{ task.test_input_json }}">
<input type="hidden" id="expected-output" value="{{ task.expected_output_json }}">

{% endblock %}

{% block extra_js %}
<!-- Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
<!-- Pyodide (WebAssembly Python) -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

<script>
    let editor;
    let pyodide = null;
    const outputDiv = document.getElementById('output');
    const runBtn = document.getElementById('runBtn');
    const spinner = document.getElementById('spinner');

    // 1. Initialize Monaco Editor
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
    require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
            value: document.getElementById('initial-code').value,
            language: 'python',
            theme: 'vs-dark',
            fontSize: 14,
            minimap: { enabled: false },
            automaticLayout: true
        });
    });

    // 2. Initialize Pyodide
    async function initPyodide() {
        outputDiv.innerHTML = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ Python —Å—Ä–µ–¥—ã (Pyodide)...";
        try {
            pyodide = await loadPyodide();
            // Load numpy if needed (clustering tasks usually need it)
            await pyodide.loadPackage("numpy");
            outputDiv.innerHTML = "‚úÖ –°—Ä–µ–¥–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ '–ó–∞–ø—É—Å—Ç–∏—Ç—å'.";
        } catch (err) {
            outputDiv.innerHTML = `<span class="output-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Pyodide: ${err}</span>`;
        }
    }
    initPyodide(); // Start loading immediately

    // 3. Run Code Function
    async function runCode() {
        if (!pyodide) {
            alert("Python —Å—Ä–µ–¥–∞ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...");
            return;
        }

        const userCode = editor.getValue();
        const functionName = document.getElementById('function-name').value;
        // Parse JSON safely. If simple string/number, use as is.
        let testInput = JSON.parse(document.getElementById('test-input').value || 'null');
        let expectedOutput = JSON.parse(document.getElementById('expected-output').value || 'null');

        runBtn.disabled = true;
        spinner.style.display = 'block';
        document.getElementById('btnText').innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
        outputDiv.innerHTML = "üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...";

        try {
            // A. Run User Code
            // Capture stdout
            pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
            `);
            
            await pyodide.runPythonAsync(userCode);
            
            let stdout = pyodide.runPython("sys.stdout.getvalue()");
            
            // B. Run Test Case
            // We need to inject the test call
            // Prepare inputs for Python
            pyodide.globals.set("test_input_js", testInput);
            
            let testCode = `
import numpy as np

# Try to find the user function
if '${functionName}' not in globals():
    raise Exception(f"–§—É–Ω–∫—Ü–∏—è '${functionName}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")

func = globals()['${functionName}']
inp = test_input_js

# Call logic handling list args vs single arg
if isinstance(inp, list):
    try:
        result = func(*inp)
    except TypeError:
        result = func(inp)
else:
    result = func(inp)

result
            `;
            
            let result = await pyodide.runPythonAsync(testCode);
            
            // C. Compare Results (in JS)
            // Convert PyProxy to JS object if needed
            let jsResult = result;
            if (result && result.toJs) {
                jsResult = result.toJs();
            }
            
            // Simple comparison (needs improvement for arrays/numpy)
            let isCorrect = JSON.stringify(jsResult) === JSON.stringify(expectedOutput);
            
            // Also try loose comparison if strict fails
            if (!isCorrect && typeof jsResult === 'number' && typeof expectedOutput === 'number') {
                isCorrect = Math.abs(jsResult - expectedOutput) < 0.01;
            }

            // Display Result
            let statusHtml = isCorrect 
                ? `<div class="output-success">‚úÖ <strong>–ü—Ä–∞–≤–∏–ª—å–Ω–æ!</strong></div>`
                : `<div class="output-error">‚ùå <strong>–û—à–∏–±–∫–∞!</strong><br>–û–∂–∏–¥–∞–ª–æ—Å—å: ${JSON.stringify(expectedOutput)}<br>–ü–æ–ª—É—á–µ–Ω–æ: ${JSON.stringify(jsResult)}</div>`;
            
            outputDiv.innerHTML = `${statusHtml}<br><div><strong>–ö–æ–Ω—Å–æ–ª—å:</strong><br>${stdout}</div>`;

            // D. Save Progress to Server (Only if correct)
            if (isCorrect) {
                saveProgress(userCode, true);
            }

        } catch (err) {
            outputDiv.innerHTML = `<span class=\"output-error\">‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:<br>${err}</span>`;
        } finally {
            runBtn.disabled = false;
            spinner.style.display = 'none';
            document.getElementById('btnText').innerText = "‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É";
        }
    }

    async function saveProgress(code, isCorrect) {
        const slug = document.getElementById('task-slug').value;
        const csrfToken = document.cookie.match(/csrftoken=([^;]+)/)?.[1];

        try {
            await fetch('/simulator/api/check_solution/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    slug: slug,
                    code: code,
                    is_client_side_check: true, // Tell server this is a status update
                    is_correct: isCorrect
                })
            });
            console.log("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
        }
    }
</script>
{% endblock %}
