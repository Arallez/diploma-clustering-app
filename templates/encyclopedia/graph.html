{% extends 'base.html' %}
{% load static %}

{% block title %}–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- D3.js Library -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Ontology Graph Styles -->
<link rel="stylesheet" href="{% static 'css/ontology_graph.css' %}">
{% endblock %}

{% block content %}
<div class="graph-page-container">
    <div class="graph-header">
        <h1>üåå –û–Ω—Ç–æ–ª–æ–≥–∏—è –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
        <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π. –ù–∞–≤–µ–¥–∏—Ç–µ –º—ã—à—å –Ω–∞ —É–∑–µ–ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤—è–∑–∏, –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ç–µ–æ—Ä–∏–∏.</p>
    </div>
    
    <!-- Graph Canvas & Overlays -->
    <div class="graph-workspace">
        
        <!-- Controls Overlay (Top Left) -->
        <div class="graph-controls">
            <button class="graph-btn" id="btn-zoom-in" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
            <button class="graph-btn" id="btn-zoom-out" title="–£–º–µ–Ω—å—à–∏—Ç—å">-</button>
            <button class="graph-btn" id="btn-reset" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—Ç—Ä">‚åÇ</button>
        </div>

        <!-- Layout Toolbar (Bottom Center) -->
        <div class="layout-toolbar">
            <button class="toolbar-btn active" data-layout="force">–°–≤–æ–±–æ–¥–Ω—ã–π</button>
            <button class="toolbar-btn" data-layout="tree">–ò–µ—Ä–∞—Ä—Ö–∏—è</button>
            <button class="toolbar-btn" data-layout="radial">–†–∞–¥–∏–∞–ª—å–Ω—ã–π</button>
        </div>

        <!-- Protege-style Legend Overlay (Bottom Right) -->
        <div class="graph-legend">
            <div class="legend-title">–õ–µ–≥–µ–Ω–¥–∞ —É–∑–ª–æ–≤</div>
            <div class="legend-grid">
                <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div>–ê–ª–≥–æ—Ä–∏—Ç–º—ã</div>
                <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
                <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div>–ú–µ—Ç—Ä–∏–∫–∏</div>
                <div class="legend-item"><div class="legend-color" style="background: #8b5cf6;"></div>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ</div>
                <div class="legend-item"><div class="legend-color" style="background: #ec4899;"></div>–ì–µ–æ–º–µ—Ç—Ä–∏—è</div>
                <div class="legend-item"><div class="legend-color" style="background: #14b8a6;"></div>–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å</div>
                <div class="legend-item"><div class="legend-color" style="background: #f43f5e;"></div>–†–∞–∑–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–æ–≤</div>
                <div class="legend-item"><div class="legend-color" style="background: #64748b;"></div>–¢–∏–ø –≤—ã–≤–æ–¥–∞</div>
            </div>
            
            <div class="edge-legend">
                <div class="legend-title" style="margin-bottom: 8px;">–¢–∏–ø—ã —Å–≤—è–∑–µ–π</div>
                <div class="edge-item">
                    <svg class="edge-line"><line x1="0" y1="1" x2="24" y2="1" stroke="#94a3b8" stroke-width="2"></line></svg>
                    <span>–Ø–≤–ª—è–µ—Ç—Å—è (IS_A)</span>
                </div>
                <div class="edge-item">
                    <svg class="edge-line"><line x1="0" y1="1" x2="24" y2="1" stroke="#10b981" stroke-width="2" stroke-dasharray="10,5"></line></svg>
                    <span>–Ø–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é (PART_OF)</span>
                </div>
                <div class="edge-item">
                    <svg class="edge-line"><line x1="0" y1="1" x2="24" y2="1" stroke="#3b82f6" stroke-width="2" stroke-dasharray="2,4"></line></svg>
                    <span>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç (USES)</span>
                </div>
                <div class="edge-item">
                    <svg class="edge-line"><line x1="0" y1="1" x2="24" y2="1" stroke="#ef4444" stroke-width="2" stroke-dasharray="6,6"></line></svg>
                    <span>–ó–∞–≤–∏—Å–∏—Ç –æ—Ç (DEPENDS)</span>
                </div>
                <div class="edge-item">
                    <svg class="edge-line"><line x1="0" y1="1" x2="24" y2="1" stroke="#8b5cf6" stroke-width="2"></line></svg>
                    <span>–°–≤—è–∑–∞–Ω–æ —Å (RELATED)</span>
                </div>
            </div>
        </div>

        <!-- Main Graph Area (SVG Container) -->
        <div class="graph-main-area">
            <div id="ontology-graph"></div>
        </div>
        
        <!-- Info Panel Overlay (Slides in from right) -->
        <div id="graph-info-panel" class="graph-info-panel">
            <!-- Content injected dynamically via JS on hover -->
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Graph Visualization Logic -->
<script src="{% static 'js/ontology_graph.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Fetch data from Django context
        const nodesData = [
            {% for concept in concepts %}
            {
                id: "{{ concept.id }}", 
                title: "{{ concept.title|escapejs }}",
                uri: "{{ concept.uri|escapejs }}",
                // Extended parsing matching standard Protege Domains
                group: {% if 'Algo' in concept.uri %}1
                       {% elif 'Param' in concept.uri %}2
                       {% elif 'Metric' in concept.uri or 'Distance' in concept.uri %}3
                       {% elif 'UC' in concept.uri or 'UseCase' in concept.uri %}4
                       {% elif 'Geometry' in concept.uri %}5
                       {% elif 'Scalability' in concept.uri %}6
                       {% elif 'ClusterSize' in concept.uri or 'Size' in concept.uri %}7
                       {% elif 'Inference' in concept.uri or 'Inductive' in concept.uri or 'Transductive' in concept.uri %}8
                       {% else %}9{% endif %},
                url: "{% url 'encyclopedia:detail' concept.id %}",
                desc: "{{ concept.description|truncatewords:25|escapejs|default:'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}"
            },
            {% endfor %}
        ];

        const linksData = [
            {% for concept in concepts %}
                {% for rel in concept.relations_out.all %}
                {
                    source: "{{ concept.id }}", 
                    target: "{{ rel.target.id }}", 
                    type: "{{ rel.get_relation_type_display|escapejs }}",
                    raw_type: "{{ rel.relation_type|escapejs }}"
                },
                {% endfor %}
            {% endfor %}
        ];

        // 2. Initialize Graph
        initOntologyGraph("ontology-graph", nodesData, linksData);
    });
</script>
{% endblock %}
