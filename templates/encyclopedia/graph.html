{% extends 'base.html' %}
{% load static %}

{% block title %}–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- D3.js Library -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Ontology Graph Styles -->
<link rel="stylesheet" href="{% static 'css/ontology_graph.css' %}?v=1.1">
{% endblock %}

{% block content %}
<div class="graph-container">
    <div class="graph-header">
        <div>
            <h1>üåå –û–Ω—Ç–æ–ª–æ–≥–∏—è –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
            <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —É–∑–µ–ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤—è–∑–∏, –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ç–µ–æ—Ä–∏–∏.</p>
        </div>
        <div class="graph-legend">
            <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div>–ê–ª–≥–æ—Ä–∏—Ç–º—ã</div>
            <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
            <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div>–ú–µ—Ç—Ä–∏–∫–∏</div>
            <div class="legend-item"><div class="legend-color" style="background: #8b5cf6;"></div>–ó–∞–¥–∞—á–∏ (Use Cases)</div>
            <div class="legend-item"><div class="legend-color" style="background: #64748b;"></div>–û—Å—Ç–∞–ª—å–Ω–æ–µ</div>
        </div>
    </div>
    
    <div style="position: relative;">
        <!-- Layout Toggle Toolbar (Protege style) -->
        <div class="layout-toolbar">
            <span class="toolbar-label">–í–∏–¥:</span>
            <button class="toolbar-btn active" data-layout="force">
                –°–≤–æ–±–æ–¥–Ω—ã–π
            </button>
            <button class="toolbar-btn" data-layout="tree">
                –ò–µ—Ä–∞—Ä—Ö–∏—è (–î–µ—Ä–µ–≤–æ)
            </button>
            <button class="toolbar-btn" data-layout="radial">
                –†–∞–¥–∏–∞–ª—å–Ω—ã–π
            </button>
        </div>

        <!-- Canvas for D3 graph -->
        <div id="ontology-graph"></div>
        
        <!-- Tooltip element -->
        <div id="graph-tooltip" class="graph-tooltip"></div>
        
        <!-- Graph controls -->
        <div class="graph-controls">
            <button class="graph-btn" id="btn-zoom-in" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
            <button class="graph-btn" id="btn-zoom-out" title="–£–º–µ–Ω—å—à–∏—Ç—å">-</button>
            <button class="graph-btn" id="btn-reset" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—Ç—Ä">‚åÇ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Graph Visualization Logic -->
<script src="{% static 'js/ontology_graph.js' %}?v=1.1"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Fetch data from Django context
        const nodesData = [
            {% for concept in concepts %}
            {
                id: "{{ concept.id }}", 
                title: "{{ concept.title|escapejs }}",
                uri: "{{ concept.uri|escapejs }}",
                group: {% if 'Algo' in concept.uri %}1
                       {% elif 'Param' in concept.uri %}2
                       {% elif 'Metric' in concept.uri %}3
                       {% elif 'UC' in concept.uri %}4
                       {% else %}5{% endif %},
                url: "{% url 'encyclopedia:detail' concept.id %}",
                desc: "{{ concept.description|truncatewords:25|escapejs|default:'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}"
            },
            {% endfor %}
        ];

        const linksData = [
            {% for concept in concepts %}
                {% for rel in concept.relations_out.all %}
                {
                    source: "{{ concept.id }}", 
                    target: "{{ rel.target.id }}", 
                    type: "{{ rel.get_relation_type_display|escapejs }}"
                },
                {% endfor %}
            {% endfor %}
        ];

        // 2. Initialize Graph from external JS file
        initOntologyGraph("ontology-graph", nodesData, linksData);
    });
</script>
{% endblock %}
