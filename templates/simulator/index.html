{% extends 'base.html' %}

{% block title %}Clustering Simulator{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/simulator.css">
{% endblock %}

{% block content %}
<!-- Vue App Wrapper -->
{% verbatim %}
<div id="app">
    
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <div class="logo-icon"></div>
            <span class="brand-text">Clustering Trainer</span>
        </a>
        <div class="nav-links">
            <a href="/simulator/" class="nav-item active">Simulator</a>
            <a href="/simulator/tasks/" class="nav-item">Tasks</a>
        </div>
    </nav>

    <div class="layout">
        <!-- Sidebar Controls -->
        <aside class="sidebar">
            <div class="control-group">
                <span class="control-label">Algorithm</span>
                <select class="cluster-input full-width" v-model="algorithm">
                    <option value="kmeans">K-Means Clustering</option>
                    <option value="dbscan">DBSCAN</option>
                    <option value="hierarchical" disabled>Hierarchical (Coming Soon)</option>
                </select>
            </div>

            <!-- Controls for K-Means -->
            <div class="control-group" v-if="algorithm === 'kmeans'">
                <span class="control-label">Clusters (K)</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="k > 1 ? k-- : null">-</button>
                    <input type="number" v-model="k" class="cluster-input" min="1" max="10">
                    <button class="btn btn-outline" @click="k < 10 ? k++ : null">+</button>
                </div>
            </div>

            <!-- Controls for DBSCAN -->
            <div class="control-group" v-if="algorithm === 'dbscan'">
                <span class="control-label">Epsilon (Radius)</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="eps = Math.max(0.1, (parseFloat(eps) - 0.1).toFixed(1))">-</button>
                    <input type="number" v-model.number="eps" class="cluster-input" step="0.1" min="0.1" max="5.0">
                    <button class="btn btn-outline" @click="eps = Math.min(5.0, (parseFloat(eps) + 0.1).toFixed(1))">+</button>
                </div>
            </div>

            <div class="control-group" v-if="algorithm === 'dbscan'">
                <span class="control-label">Min Points</span>
                <div class="k-controls">
                    <button class="btn btn-outline" @click="minPts > 1 ? minPts-- : null">-</button>
                    <input type="number" v-model="minPts" class="cluster-input" min="1" max="20">
                    <button class="btn btn-outline" @click="minPts < 20 ? minPts++ : null">+</button>
                </div>
            </div>

            <div class="control-group">
                <span class="control-label">Actions</span>
                <button class="btn btn-outline" @click="clearPoints">Clear Board</button>
                <button class="btn" @click="runAlgorithm" :disabled="points.length === 0 || isRunning">
                    {{ isRunning ? 'Processing...' : 'Run Algorithm' }}
                </button>
            </div>

            <div class="help-box">
                <div v-if="algorithm === 'kmeans'">
                    <strong>üí° How to use K-Means:</strong><br>
                    1. Click to add points.<br>
                    2. Select number of clusters (K).<br>
                    3. Press "Run".
                </div>
                <div v-else-if="algorithm === 'dbscan'">
                    <strong>üí° How to use DBSCAN:</strong><br>
                    1. Add points (try shapes like moons).<br>
                    2. Set <b>Epsilon</b> (radius) and <b>MinPts</b>.<br>
                    3. Run to see noise vs clusters.
                </div>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="workspace">
            
            <!-- Info Chips -->
            <div class="stats-bar">
                <div class="stat-chip">Points: <span class="stat-value">{{ points.length }}</span></div>
                <div class="stat-chip" v-if="algorithm === 'kmeans'">K: <span class="stat-value">{{ k }}</span></div>
                <div class="stat-chip" v-else>Eps: <span class="stat-value">{{ eps }}</span></div>
                <div class="stat-chip">Steps: <span class="stat-value">{{ history.length ? history.length : 0 }}</span></div>
            </div>

            <!-- Visualization -->
            <div class="graph-card">
                <div id="plot" @click="handleCanvasClick"></div>
            </div>

            <!-- Step Player -->
            <transition name="fade">
                <div class="step-control" v-if="history.length > 0">
                    <button class="btn btn-outline" @click="setStep(0)">‚èÆ</button>
                    <button class="btn btn-outline" @click="prevStep">‚óÄ</button>
                    
                    <div class="slider-container">
                        <span class="step-label align-right">{{ currentStep }}</span>
                        <input type="range" min="0" :max="history.length - 1" v-model.number="currentStep">
                        <span class="step-label">{{ history.length - 1 }}</span>
                    </div>

                    <button class="btn btn-outline" @click="nextStep">‚ñ∂</button>
                    <button class="btn btn-outline" @click="setStep(history.length - 1)">‚è≠</button>
                </div>
            </transition>

        </main>
    </div>

</div>
{% endverbatim %}
{% endblock %}

{% block extra_js %}
<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<!-- Vue.js 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<!-- New Modular Architecture -->
<script type="module" src="/static/js/simulator/app.js"></script>
{% endblock %}
