{% extends 'base.html' %}

{% block title %}{{ task.title }} | Задачи{% endblock %}

{% block extra_css %}
<style>
    /* Layout */
    .challenge-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        height: calc(100vh - 120px);
        margin: 1rem 2rem;
    }
    
    /* Left Panel */
    .task-desc {
        background: #1e293b;
        padding: 2rem;
        border-radius: 12px;
        overflow-y: auto;
        color: #e2e8f0;
        border: 1px solid #334155;
    }
    
    /* Right Panel */
    .editor-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .code-editor {
        flex: 1;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 1rem;
        color: #f8fafc;
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 15px;
        resize: none;
        outline: none;
        line-height: 1.5;
    }
    .code-editor:focus {
        border-color: #3b82f6;
    }
    
    /* Buttons */
    .actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }
    
    .btn {
        padding: 0.7rem 1.4rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
    }
    
    .btn-primary {
        background: #2563eb;
        color: white;
    }
    .btn-primary:hover { background: #1d4ed8; }
    
    .btn-secondary {
        background: #334155;
        color: #e2e8f0;
    }
    .btn-secondary:hover { background: #475569; }
    
    /* Back Link */
    .back-link {
        display: inline-block;
        margin-bottom: 1.5rem;
        color: #94a3b8;
        text-decoration: none;
        font-weight: 500;
        padding: 0.4rem 0.8rem;
        background: #0f172a;
        border-radius: 6px;
        border: 1px solid #334155;
        transition: all 0.2s;
    }
    .back-link:hover {
        color: #f1f5f9;
        border-color: #475569;
        background: #1e293b;
    }

    /* Badges */
    .badge-row {
        display: flex;
        gap: 0.8rem;
        margin-top: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .difficulty-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    .level-1 { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .level-2 { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .level-3 { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    
    .algo-tag {
        background: #0f172a;
        color: #94a3b8;
        padding: 0.3rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        border: 1px solid #334155;
    }

    /* Result Box */
    .result-box {
        margin-top: 0;
        padding: 1rem;
        border-radius: 8px;
        display: none; /* Hidden by default */
        font-family: sans-serif;
        line-height: 1.5;
    }
    
    .result-box.success {
        display: block;
        background: #064e3b;
        color: #a7f3d0;
        border: 1px solid #059669;
    }
    
    .result-box.error {
        display: block;
        background: #450a0a;
        color: #fca5a5;
        border: 1px solid #b91c1c;
    }

    /* Navbar Fix: Force border on buttons in header */
    header .btn-outline, .navbar .btn-outline {
        border: 1px solid #475569 !important;
        padding: 0.5rem 1rem !important;
        border-radius: 6px !important;
        color: #e2e8f0 !important;
        text-decoration: none !important;
    }
    header .btn-outline:hover, .navbar .btn-outline:hover {
        background-color: #334155 !important;
        color: #fff !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="challenge-layout">
    <!-- Left: Task Description -->
    <div class="task-desc">
        <a href="{% url 'simulator:task_list' %}" class="back-link">← Назад к списку</a>
        
        <h1 style="margin: 0; font-size: 1.8rem; color: #f1f5f9;">{{ task.title }}</h1>
        
        <div class="badge-row">
            <span class="difficulty-badge level-{{ task.difficulty }}">
                {% if task.difficulty == 1 %}Easy
                {% elif task.difficulty == 2 %}Medium
                {% else %}Hard{% endif %}
            </span>
            <span class="algo-tag">{{ task.get_algorithm_display }}</span>
        </div>
        
        <div class="description-content" style="margin-top: 1.5rem; line-height: 1.7;">
            {{ task.description|safe }}
        </div>
        
        <div class="examples" style="margin-top: 2rem;">
            <h3 style="color: #cbd5e1;">Пример:</h3>
            <pre style="background: #0f172a; padding: 1rem; border-radius: 6px; color: #e2e8f0; overflow-x: auto;"><code>Input: {{ task.test_input }}
Output: {{ task.expected_output }}</code></pre>
        </div>
    </div>

    <!-- Right: Code Editor -->
    <div class="editor-container">
        <textarea id="code-editor" class="code-editor" spellcheck="false" placeholder="Напишите ваше решение здесь...">{{ previous_code }}</textarea>
        
        <div id="result-box" class="result-box"></div>

        <div class="actions">
            <button class="btn btn-secondary" onclick="resetCode()">Сбросить</button>
            <button class="btn btn-primary" onclick="submitSolution()">Проверить решение ▶</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const initialCode = `{{ task.initial_code|escapejs }}`;
    
    function resetCode() {
        if(confirm('Сбросить код к начальному состоянию?')) {
            document.getElementById('code-editor').value = initialCode;
            document.getElementById('result-box').style.display = 'none';
        }
    }
    
    async function submitSolution() {
        const code = document.getElementById('code-editor').value;
        const resultBox = document.getElementById('result-box');
        
        // Show loading state
        resultBox.style.display = 'block';
        resultBox.className = 'result-box';
        resultBox.style.background = '#1e293b';
        resultBox.style.color = '#94a3b8';
        resultBox.innerHTML = '⏳ Проверка...';
        
        try {
            const response = await fetch('/simulator/api/check-solution/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    slug: '{{ task.slug }}',
                    code: code
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultBox.className = 'result-box success';
                resultBox.style.display = 'block'; // Force show
                resultBox.innerHTML = '✅ <b>Верно!</b> ' + data.message;
            } else {
                resultBox.className = 'result-box error';
                resultBox.style.display = 'block'; // Force show
                resultBox.innerHTML = '❌ <b>Ошибка:</b> ' + (data.error || 'Неверный ответ');
            }
        } catch (e) {
            console.error(e);
            resultBox.className = 'result-box error';
            resultBox.style.display = 'block'; // Force show
            resultBox.innerHTML = '❌ Ошибка сети: ' + e.message;
        }
    }
</script>
{% endblock %}
