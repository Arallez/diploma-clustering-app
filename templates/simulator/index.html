<!DOCTYPE html>
<html>
<head>
    <title>K-Means Simulator</title>
    <!-- Подключаем Vue.js и Plotly через CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #plot { width: 100%; height: 500px; border: 1px solid #ccc; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="app">
        <h1>Тренажер K-Means</h1>
        
        {% verbatim %}
        <div class="controls">
            <label>Количество кластеров (k): <input type="number" v-model="k" min="1" max="5"></label>
            <button @click="clearPoints">Очистить</button>
            <button @click="runAlgorithm" :disabled="points.length === 0">Запустить алгоритм</button>
        </div>

        <div v-if="history.length > 0">
            <button @click="prevStep" :disabled="currentStep === 0">Назад</button>
            <span>Шаг: {{ currentStep }} / {{ history.length - 1 }}</span>
            <button @click="nextStep" :disabled="currentStep === history.length - 1">Вперед</button>
            <p v-if="currentStepData">Инерция (ошибка): {{ currentStepData.inertia.toFixed(2) }}</p>
        </div>
        {% endverbatim %}

        <div id="plot"></div>
        
        <p>Кликните по графику, чтобы добавить точки.</p>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    points: [], // [[x,y], [x,y]]
                    k: 3,
                    history: [],
                    currentStep: 0
                }
            },
            computed: {
                currentStepData() {
                    return this.history[this.currentStep];
                }
            },
            mounted() {
                this.initPlot();
            },
            methods: {
                initPlot() {
                    const layout = {
                        title: 'Поле для кластеризации',
                        hovermode: 'closest',
                        xaxis: { range: [0, 10] },
                        yaxis: { range: [0, 10] }
                    };
                    
                    Plotly.newPlot('plot', [{
                        x: [], y: [], mode: 'markers', type: 'scatter',
                        marker: { size: 10 }
                    }], layout);

                    document.getElementById('plot').on('plotly_click', (data) => {
                        // Plotly возвращает координаты кликнутой точки, но не пустой области.
                        // Поэтому для добавления используем другой подход в MVP.
                    });
                },
                
                addRandomPoints() {
                    for(let i=0; i<10; i++) {
                        this.points.push([Math.random()*10, Math.random()*10]);
                    }
                    this.draw();
                },

                clearPoints() {
                    this.points = [];
                    this.history = [];
                    this.currentStep = 0;
                    this.draw();
                },

                draw() {
                    // Рисуем точки
                    const tracePoints = {
                        x: this.points.map(p => p[0]),
                        y: this.points.map(p => p[1]),
                        mode: 'markers',
                        type: 'scatter',
                        name: 'Данные',
                        marker: { size: 10, color: 'blue' }
                    };
                    
                    const data = [tracePoints];

                    // Если есть история, рисуем центроиды и раскрашиваем точки
                    if (this.history.length > 0) {
                        const stepData = this.history[this.currentStep];
                        
                        // Раскрашиваем точки по кластерам
                        tracePoints.marker.color = stepData.labels; // Plotly умеет принимать массив цветов (чисел)
                        tracePoints.marker.colorscale = 'Viridis';
                        
                        // Добавляем центроиды
                        const traceCentroids = {
                            x: stepData.centroids.map(c => c[0]),
                            y: stepData.centroids.map(c => c[1]),
                            mode: 'markers',
                            type: 'scatter',
                            name: 'Центроиды',
                            marker: { size: 20, color: 'red', symbol: 'x' }
                        };
                        data.push(traceCentroids);
                    }

                    Plotly.react('plot', data, document.getElementById('plot').layout);
                },

                async runAlgorithm() {
                    // Обратите внимание: CSRF токен важен для Django POST запросов
                    // В MVP мы его отключим в API или передадим через headers
                    const response = await fetch('/simulator/api/run-kmeans/', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCookie('csrftoken') 
                        },
                        body: JSON.stringify({ points: this.points, k: this.k })
                    });
                    this.history = await response.json();
                    this.currentStep = 0;
                    this.draw();
                },
                
                getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                },

                nextStep() {
                    if (this.currentStep < this.history.length - 1) {
                        this.currentStep++;
                        this.draw();
                    }
                },
                prevStep() {
                    if (this.currentStep > 0) {
                        this.currentStep--;
                        this.draw();
                    }
                }
            }
        }).mount('#app')
    </script>
    
    <!-- Временная кнопка для генерации данных -->
    <div style="position: absolute; top: 100px; right: 50px;">
        <button onclick="document.querySelector('#app').__vue_app__._instance.ctx.addRandomPoints()">+ 10 Случайных точек</button>
    </div>
</body>
</html>
