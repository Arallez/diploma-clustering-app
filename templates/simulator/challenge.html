<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Code Challenge: Centroids</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Pyodide (Python in Browser) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Monaco Editor Loader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

  <style>
    :root {
      --bg: #0b1020;
      --card-bg: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.1);
      --accent: #7c5cff;
      --success: #22c55e;
      --error: #ef4444;
      --text: #e2e8f0;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header {
      height: 50px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      background: rgba(0,0,0,0.2);
    }

    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 400px 1fr;
      height: calc(100vh - 50px);
    }

    .task-panel {
      border-right: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
      background: rgba(0,0,0,0.1);
    }

    .task-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #fff; }
    .task-desc { font-size: 14px; line-height: 1.6; color: #94a3b8; margin-bottom: 20px; }

    .example-box {
      background: rgba(255,255,255,0.03);
      padding: 10px;
      border-radius: 6px;
      font-family: 'Fira Code', monospace;
      font-size: 12px;
      margin: 10px 0;
      border: 1px solid var(--border);
    }

    .editor-panel {
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
    }

    #editor-container { flex: 1; width: 100%; }

    .toolbar {
      height: 50px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 20px;
      background: #18181b;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .btn-run { background: var(--success); color: #000; }
    .btn-run:hover { opacity: 0.9; }

    .btn-reset { background: rgba(255,255,255,0.1); color: #fff; }

    .status-msg {
      margin-right: auto;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .loading { color: #facc15; }
    .success { color: #4ade80; }
    .error { color: #f87171; }
  </style>
</head>
<body>

<div id="app" style="height: 100%;">
  <header class="header">
    <strong>üéì Code Challenge:</strong> &nbsp; <span style="color: #94a3b8;">K-Means Part 1</span>
    <a href="/simulator/" style="margin-left: auto; color: #fff; text-decoration: none; font-size: 13px;">Back to Simulator ‚Üí</a>
  </header>

  <div class="main">
    <div class="task-panel">
      <div class="task-title">–ó–∞–¥–∞—á–∞ 1: –ü–µ—Ä–µ—Å—á–µ—Ç —Ü–µ–Ω—Ç—Ä–æ–∏–¥–∞</div>
      <div class="task-desc">
        <p>–í –∞–ª–≥–æ—Ä–∏—Ç–º–µ K-Means –∫–ª—é—á–µ–≤–æ–π —à–∞–≥ ‚Äî –ø–µ—Ä–µ—Å—á–µ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è —Ü–µ–Ω—Ç—Ä–æ–∏–¥–æ–≤.</p>
        <p>–¶–µ–Ω—Ç—Ä–æ–∏–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ <b>—Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ</b> –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—Å–µ—Ö —Ç–æ—á–µ–∫, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏—Ö —ç—Ç–æ–º—É –∫–ª–∞—Å—Ç–µ—Ä—É.</p>
        <p><b>–í–∞—à–∞ –∑–∞–¥–∞—á–∞:</b><br>
        –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é <code>calculate_centroid(points)</code>, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö —Ü–µ–Ω—Ç—Ä –º–∞—Å—Å [x, y].</p>
      </div>

      <div class="example-box">
        INPUT:<br>
        points = [[0, 0], [4, 4], [2, 2]]<br><br>
        OUTPUT:<br>
        [2.0, 2.0]<br>
        <span style="color: #64748b;">// (0+4+2)/3 = 2</span>
      </div>

      <div class="task-desc" style="margin-top: 20px;">
        <p><i>–ü–æ–¥—Å–∫–∞–∑–∫–∞: –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É <code>numpy</code> –∫–∞–∫ <code>np</code>, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ.</i></p>
      </div>
    </div>

    <div class="editor-panel">
      <div id="editor-container"></div>

      <div class="toolbar">
        <div class="status-msg">
            <span v-if="isRunning" class="loading">‚è≥ –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–¥...</span>
            <span v-if="resultStatus === 'success'" class="success">‚úÖ {{ resultMessage }}</span>
            <span v-if="resultStatus === 'error'" class="error">‚ùå {{ resultMessage }}</span>
        </div>

        <button class="btn btn-reset" @click="resetCode">–°–±—Ä–æ—Å</button>
        <button class="btn btn-run" @click="runCode" :disabled="!isPyodideReady || isRunning">
          {{ isPyodideReady ? '‚ñ∂ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ' : '–ó–∞–≥—Ä—É–∑–∫–∞ Python...' }}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp, onMounted, ref } = Vue

createApp({
  setup() {
    const isPyodideReady = ref(false)
    const isRunning = ref(false)
    const resultStatus = ref('')
    const resultMessage = ref('')
    let pyodide = null
    let editor = null

    const defaultCode = `# –ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å
import numpy as np

def calculate_centroid(points):
    """
    points: —Å–ø–∏—Å–æ–∫ —Å–ø–∏—Å–∫–æ–≤ [[x1, y1], [x2, y2], ...]
    Return: [x_avg, y_avg]
    """
    # –í–ê–® –ö–û–î –ó–î–ï–°–¨:
    x_sum = 0
    y_sum = 0

    # ...

    return [0, 0] # –ó–∞–≥–ª—É—à–∫–∞
`

    const initEditor = () => {
      require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }})
      require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('editor-container'), {
          value: defaultCode,
          language: 'python',
          theme: 'vs-dark',
          minimap: { enabled: false },
          fontSize: 14,
          automaticLayout: true
        })
      })
    }

    const initPyodide = async () => {
      try {
        pyodide = await loadPyodide()
        await pyodide.loadPackage('numpy')
        isPyodideReady.value = true
      } catch(e) {
        console.error('Pyodide failed', e)
      }
    }

    const runCode = async () => {
      if (!pyodide) return
      isRunning.value = true
      resultStatus.value = ''
      resultMessage.value = ''

      const userCode = editor.getValue()
      const testPoints = [[0,0], [4,4], [2,2]]

      // IMPORTANT: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –≤—Å–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ ‚Äî —ç—Ç–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ `out`
      // –¢–æ–≥–¥–∞ pyodide.runPythonAsync() –≤—Å–µ–≥–¥–∞ –≤–µ—Ä–Ω–µ—Ç —Å—Ç—Ä–æ–∫—É.
      const wrapper = `
import json

out = None

# 1) –ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å calculate_centroid)
${userCode}

# 2) –¢–µ—Å—Ç
try:
    pts = ${JSON.stringify(testPoints)}

    if 'calculate_centroid' not in locals():
        out = json.dumps({"ERROR_IN_PY": "–§—É–Ω–∫—Ü–∏—è calculate_centroid –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"})
    else:
        result = calculate_centroid(pts)

        # numpy -> list
        if hasattr(result, 'tolist'):
            result = result.tolist()

        out = json.dumps(result)
except Exception as e:
    out = json.dumps({"ERROR_IN_PY": str(e)})

out
`;

      try {
        const jsonOutput = await pyodide.runPythonAsync(wrapper)

        if (typeof jsonOutput !== 'string') {
          throw new Error('Pyodide –≤–µ—Ä–Ω—É–ª –Ω–µ —Å—Ç—Ä–æ–∫—É')
        }

        const output = JSON.parse(jsonOutput)

        if (output && output.ERROR_IN_PY) {
          resultStatus.value = 'error'
          resultMessage.value = '–û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ: ' + output.ERROR_IN_PY
          return
        }

        const response = await fetch('/simulator/api/check-solution/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ task_id: 'centroid_calc', result: output })
        })

        const serverResp = await response.json()

        if (serverResp.correct) {
          resultStatus.value = 'success'
          resultMessage.value = serverResp.message
        } else {
          resultStatus.value = 'error'
          resultMessage.value = serverResp.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç'
        }
      } catch (e) {
        console.error(e)
        resultStatus.value = 'error'
        resultMessage.value = '–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞: ' + e.message
      } finally {
        isRunning.value = false
      }
    }

    const resetCode = () => {
      if (editor) editor.setValue(defaultCode)
      resultStatus.value = ''
      resultMessage.value = ''
    }

    onMounted(() => {
      initEditor()
      initPyodide()
    })

    return {
      isPyodideReady,
      isRunning,
      runCode,
      resetCode,
      resultStatus,
      resultMessage
    }
  }
}).mount('#app')
</script>

</body>
</html>
