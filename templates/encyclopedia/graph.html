{% extends 'base.html' %}
{% load static %}

{% block title %}–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- D3.js –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∞ -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
.graph-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem 2rem;
}
.graph-header {
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}
.graph-header h1 {
    color: var(--text-color);
    margin-bottom: 0.5rem;
}
.graph-header p {
    color: var(--text-muted);
    margin: 0;
}
/* –õ–µ–≥–µ–Ω–¥–∞ (–∫–∞–∫ –≤ Protege) */
.graph-legend {
    display: flex;
    gap: 15px;
    background: var(--card-bg);
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    font-size: 13px;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-color);
}
.legend-color {
    width: 14px;
    height: 14px;
    border-radius: 50%;
}

#ontology-graph {
    width: 100%;
    height: 75vh;
    min-height: 600px;
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    cursor: grab;
}
#ontology-graph:active {
    cursor: grabbing;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è D3 */
.node circle {
    stroke: var(--bg-color);
    stroke-width: 2px;
    transition: all 0.2s;
}
.node text {
    font-size: 12px;
    font-family: 'Inter', sans-serif;
    font-weight: 500;
    fill: var(--text-color);
    pointer-events: none;
    text-shadow: 0px 1px 3px var(--bg-color), 0px -1px 3px var(--bg-color), 1px 0px 3px var(--bg-color), -1px 0px 3px var(--bg-color);
}
.link {
    stroke: var(--text-muted);
    stroke-opacity: 0.4;
    stroke-width: 1.5px;
}
/* –¢–µ–∫—Å—Ç –Ω–∞ —Å–≤—è–∑—è—Ö (–∫–∞–∫ –≤ Protege) */
.link-label {
    font-size: 10px;
    font-family: 'Fira Code', monospace;
    fill: var(--text-muted);
    pointer-events: none;
    text-anchor: middle;
    background: var(--bg-color);
    text-shadow: 0px 1px 2px var(--bg-color), 0px -1px 2px var(--bg-color), 1px 0px 2px var(--bg-color), -1px 0px 2px var(--bg-color);
}

/* Tooltip */
.tooltip {
    position: absolute;
    padding: 12px;
    background: var(--card-bg);
    border: 1px solid var(--primary-color);
    color: var(--text-color);
    border-radius: 6px;
    pointer-events: none;
    font-size: 13px;
    opacity: 0;
    transition: opacity 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    max-width: 300px;
    line-height: 1.4;
}

/* Controls */
.graph-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.graph-btn {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    width: 36px;
    height: 36px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}
.graph-btn:hover {
    background: var(--primary-color);
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="graph-container">
    <div class="graph-header">
        <div>
            <h1>üåå –û–Ω—Ç–æ–ª–æ–≥–∏—è –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
            <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —É–∑–µ–ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤—è–∑–∏, –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ç–µ–æ—Ä–∏–∏.</p>
        </div>
        <div class="graph-legend">
            <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div>–ê–ª–≥–æ—Ä–∏—Ç–º—ã</div>
            <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
            <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div>–ú–µ—Ç—Ä–∏–∫–∏</div>
            <div class="legend-item"><div class="legend-color" style="background: #8b5cf6;"></div>–ó–∞–¥–∞—á–∏ (Use Cases)</div>
            <div class="legend-item"><div class="legend-color" style="background: #64748b;"></div>–û—Å—Ç–∞–ª—å–Ω–æ–µ</div>
        </div>
    </div>
    
    <div style="position: relative;">
        <div id="ontology-graph"></div>
        <div id="graph-tooltip" class="tooltip"></div>
        <div class="graph-controls">
            <button class="graph-btn" id="btn-zoom-in" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
            <button class="graph-btn" id="btn-zoom-out" title="–£–º–µ–Ω—å—à–∏—Ç—å">-</button>
            <button class="graph-btn" id="btn-reset" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—Ç—Ä">‚åÇ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Django
        const nodes = [
            {% for concept in concepts %}
            {
                id: "{{ concept.id }}", 
                title: "{{ concept.title|escapejs }}",
                uri: "{{ concept.uri|escapejs }}",
                // –†–∞—Å–∫—Ä–∞—Å–∫–∞ —É–∑–ª–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç URI (–∫–∞–∫ –∫–ª–∞—Å—Å—ã –≤ Protege)
                group: {% if 'Algo' in concept.uri %}1
                       {% elif 'Param' in concept.uri %}2
                       {% elif 'Metric' in concept.uri %}3
                       {% elif 'UC' in concept.uri %}4
                       {% else %}5{% endif %},
                url: "{% url 'encyclopedia:detail' concept.id %}",
                desc: "{{ concept.description|truncatewords:25|escapejs|default:'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}"
            },
            {% endfor %}
        ];

        const links = [
            {% for concept in concepts %}
                {% for rel in concept.relations_out.all %}
                {
                    source: "{{ concept.id }}", 
                    target: "{{ rel.target.id }}", 
                    type: "{{ rel.get_relation_type_display|escapejs }}"
                },
                {% endfor %}
            {% endfor %}
        ];

        const width = document.getElementById('ontology-graph').clientWidth;
        const height = document.getElementById('ontology-graph').clientHeight;
        
        // –¶–≤–µ—Ç–∞ (—Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ª–µ–≥–µ–Ω–¥–æ–π)
        const colors = {
            1: '#3b82f6', // –°–∏–Ω–∏–π (–ê–ª–≥–æ—Ä–∏—Ç–º—ã)
            2: '#10b981', // –ó–µ–ª–µ–Ω—ã–π (–ü–∞—Ä–∞–º–µ—Ç—Ä—ã)
            3: '#f59e0b', // –ñ–µ–ª—Ç—ã–π (–ú–µ—Ç—Ä–∏–∫–∏)
            4: '#8b5cf6', // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π (Use Cases)
            5: '#64748b'  // –°–µ—Ä—ã–π (–û—Å—Ç–∞–ª—å–Ω–æ–µ: Scalability, InferenceType, Geometry)
        };

        const svg = d3.select("#ontology-graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑—É–º–∞
        const zoom = d3.zoom()
            .scaleExtent([0.2, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });
        
        svg.call(zoom);
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
        d3.select("#btn-zoom-in").on("click", () => zoom.scaleBy(svg.transition().duration(300), 1.3));
        d3.select("#btn-zoom-out").on("click", () => zoom.scaleBy(svg.transition().duration(300), 1 / 1.3));
        d3.select("#btn-reset").on("click", () => {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity.translate(width/2, height/2).scale(0.8));
        });

        // –ú–∞—Ä–∫–µ—Ä—ã-—Å—Ç—Ä–µ–ª–æ—á–∫–∏ –¥–ª—è —Å–≤—è–∑–µ–π
        svg.append("defs").selectAll("marker")
            .data(["end", "end-highlight"])
            .enter().append("marker")
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25) // –°–¥–≤–∏–≥ —Å—Ç—Ä–µ–ª–∫–∏ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ —É–∑–ª–∞
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("fill", d => d === "end-highlight" ? "var(--primary-color)" : "var(--text-muted)")
            .attr("d", "M0,-5L10,0L0,5");

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–∑–∏–∫–∏
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(150)) // –î–ª–∏–Ω–∞ —Å–≤—è–∑–µ–π
            .force("charge", d3.forceManyBody().strength(-800)) // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ (—Ä–∞—Å–ø—Ä–∞–≤–ª—è–µ—Ç –≥—Ä–∞—Ñ)
            .force("collide", d3.forceCollide().radius(40)) // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–∞–ª–æ–∂–µ–Ω–∏–π
            .force("center", d3.forceCenter(0, 0)); // –¶–µ–Ω—Ç—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (—Å–¥–≤–∏–Ω–µ–º –Ω–∏–∂–µ)

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≥—Ä–∞—Ñ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
        svg.call(zoom.transform, d3.zoomIdentity.translate(width/2, height/2).scale(0.8));

        // –õ–∏–Ω–∏–∏ —Å–≤—è–∑–µ–π
        const link = g.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link")
            .attr("marker-end", "url(#end)");

        // –¢–µ–∫—Å—Ç –Ω–∞ —Å–≤—è–∑—è—Ö (–∫–∞–∫ –≤ Protege)
        const linkText = g.append("g")
            .attr("class", "link-labels")
            .selectAll("text")
            .data(links)
            .enter().append("text")
            .attr("class", "link-label")
            .text(d => d.type);

        // –ì—Ä—É–ø–ø—ã —É–∑–ª–æ–≤
        const node = g.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        // –ö—Ä—É–≥–∏ —É–∑–ª–æ–≤
        node.append("circle")
            .attr("r", 12)
            .attr("fill", d => colors[d.group] || colors[5]);

        // –¢–µ–∫—Å—Ç —É–∑–ª–æ–≤
        node.append("text")
            .attr("dx", 16)
            .attr("dy", ".35em")
            .text(d => d.title);

        // –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (Hover —ç—Ñ—Ñ–µ–∫—Ç—ã)
        const tooltip = d3.select("#graph-tooltip");

        node.on("mouseover", function(event, d) {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —É–∑–ª–∞
            d3.select(this).select("circle")
                .attr("r", 16)
                .attr("stroke", "var(--text-color)");
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π
            link.style("stroke-opacity", l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1)
                .style("stroke", l => (l.source.id === d.id || l.target.id === d.id) ? "var(--primary-color)" : "var(--text-muted)")
                .attr("marker-end", l => (l.source.id === d.id || l.target.id === d.id) ? "url(#end-highlight)" : "url(#end)");
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Å–≤—è–∑–µ–π
            linkText.style("opacity", l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1)
                    .style("fill", l => (l.source.id === d.id || l.target.id === d.id) ? "var(--primary-color)" : "var(--text-muted)")
                    .style("font-weight", l => (l.source.id === d.id || l.target.id === d.id) ? "bold" : "normal");

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤
            node.style("opacity", n => {
                if (n.id === d.id) return 1;
                const isConnected = links.some(l => 
                    (l.source.id === d.id && l.target.id === n.id) || 
                    (l.target.id === d.id && l.source.id === n.id)
                );
                return isConnected ? 1 : 0.2;
            });

            // Tooltip
            tooltip.transition().duration(200).style("opacity", 1);
            tooltip.html(
                `<div style="font-weight:bold; margin-bottom:5px; color:${colors[d.group]}">${d.title}</div>` +
                `<div style="font-size:11px; margin-bottom:5px; opacity:0.7;">URI: ${d.uri.split('#').pop()}</div>` +
                `<div>${d.desc}</div>`
            )
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");
        })
        .on("mouseout", function(d) {
            // –í–æ–∑–≤—Ä–∞—Ç –∫ –Ω–æ—Ä–º–µ
            d3.select(this).select("circle")
                .attr("r", 12)
                .attr("stroke", "var(--bg-color)");
            
            link.style("stroke-opacity", 0.4)
                .style("stroke", "var(--text-muted)")
                .attr("marker-end", "url(#end)");
                
            linkText.style("opacity", 1)
                    .style("fill", "var(--text-muted)")
                    .style("font-weight", "normal");
                    
            node.style("opacity", 1);

            tooltip.transition().duration(300).style("opacity", 0);
        })
        .on("click", function(event, d) {
            window.location.href = d.url;
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –∫–∞–∂–¥–æ–º —Ç–∏–∫–µ —Å–∏–º—É–ª—è—Ü–∏–∏
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            // –ü–æ–∑–∏—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å–≤—è–∑–∏ (–≤ —Ü–µ–Ω—Ç—Ä–µ –ª–∏–Ω–∏–∏)
            linkText
                .attr("x", d => (d.source.x + d.target.x) / 2)
                .attr("y", d => (d.source.y + d.target.y) / 2 - 5) // –ß—É—Ç—å –≤—ã—à–µ –ª–∏–Ω–∏–∏
                // –ü–æ–≤–æ—Ä–æ—Ç —Ç–µ–∫—Å—Ç–∞ –≤–¥–æ–ª—å –ª–∏–Ω–∏–∏
                .attr("transform", d => {
                    const angle = Math.atan2(d.target.y - d.source.y, d.target.x - d.source.x) * 180 / Math.PI;
                    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç –≤–≤–µ—Ä—Ö –Ω–æ–≥–∞–º–∏ - –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                    const finalAngle = (angle > 90 || angle < -90) ? angle + 180 : angle;
                    const cx = (d.source.x + d.target.x) / 2;
                    const cy = (d.source.y + d.target.y) / 2 - 5;
                    return `rotate(${finalAngle}, ${cx}, ${cy})`;
                });

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    });
</script>
{% endblock %}
