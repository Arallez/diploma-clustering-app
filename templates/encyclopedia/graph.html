{% extends 'base.html' %}
{% load static %}

{% block title %}–ì—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- D3.js Library -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Ontology Graph Styles -->
<link rel="stylesheet" href="{% static 'css/ontology_graph.css' %}?v=1.4">
<style>
/* Extended Legend Grid to fit more items nicely */
.graph-legend {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px 20px;
    background: var(--card-bg);
    padding: 12px 20px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    font-size: 12px;
}
</style>
{% endblock %}

{% block content %}
<div class="graph-container">
    <div class="graph-header" style="flex-direction: column; align-items: stretch; gap: 15px;">
        <div>
            <h1>üåå –û–Ω—Ç–æ–ª–æ–≥–∏—è –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
            <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —É–∑–µ–ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏. –¢–∏–ø—ã —Å–≤—è–∑–µ–π –æ–±–æ–∑–Ω–∞—á–µ–Ω—ã —Ä–∞–∑–Ω—ã–º–∏ –ª–∏–Ω–∏—è–º–∏ (–∫–∞–∫ –≤ Prot√©g√©).</p>
        </div>
        
        <!-- Legend for Node Colors -->
        <div class="graph-legend">
            <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div>–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏</div>
            <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
            <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div>–ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è</div>
            <div class="legend-item"><div class="legend-color" style="background: #8b5cf6;"></div>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (Use cases)</div>
            <div class="legend-item"><div class="legend-color" style="background: #ec4899;"></div>–ì–µ–æ–º–µ—Ç—Ä–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤</div>
            <div class="legend-item"><div class="legend-color" style="background: #14b8a6;"></div>–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å</div>
            <div class="legend-item"><div class="legend-color" style="background: #f43f5e;"></div>–†–∞–∑–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–æ–≤</div>
            <div class="legend-item"><div class="legend-color" style="background: #64748b;"></div>–¢–∏–ø –≤—ã–≤–æ–¥–∞ (Inference)</div>
        </div>
        
        <!-- Legend for Edge Types -->
        <div class="edge-legend">
            <div class="edge-legend-item">
                <span style="font-weight: 600;">–¢–∏–ø—ã —Å–≤—è–∑–µ–π:</span>
            </div>
            <div class="edge-legend-item">
                <div class="edge-line edge-is-a"></div>
                <span>–Ø–≤–ª—è–µ—Ç—Å—è / Is A (–°–ø–ª–æ—à–Ω–∞—è —Å–µ—Ä–∞—è)</span>
            </div>
            <div class="edge-legend-item">
                <div class="edge-line edge-depends"></div>
                <span>–ó–∞–≤–∏—Å–∏—Ç / Requires (–ö—Ä–∞—Å–Ω–∞—è –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è)</span>
            </div>
            <div class="edge-legend-item">
                <div class="edge-line edge-uses"></div>
                <span>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç / Uses (–°–∏–Ω—è—è —Ç–æ—á–µ—á–Ω–∞—è)</span>
            </div>
            <div class="edge-legend-item">
                <div class="edge-line edge-related"></div>
                <span>–°–≤—è–∑–∞–Ω–æ / Related (–§–∏–æ–ª–µ—Ç–æ–≤–∞—è)</span>
            </div>
        </div>
    </div>
    
    <!-- Graph & Panel Layout Wrapper -->
    <div class="graph-layout-wrapper">
        
        <!-- Main Graph Area (White Canvas) -->
        <div class="graph-main-area">
            <!-- Layout Toggle Toolbar (Protege style) -->
            <div class="layout-toolbar">
                <span class="toolbar-label">–í–∏–¥:</span>
                <button class="toolbar-btn active" data-layout="force">–°–≤–æ–±–æ–¥–Ω—ã–π</button>
                <button class="toolbar-btn" data-layout="tree">–ò–µ—Ä–∞—Ä—Ö–∏—è (–î–µ—Ä–µ–≤–æ)</button>
                <button class="toolbar-btn" data-layout="radial">–†–∞–¥–∏–∞–ª—å–Ω—ã–π</button>
            </div>

            <!-- Canvas for D3 graph -->
            <div id="ontology-graph"></div>
            
            <!-- Graph controls -->
            <div class="graph-controls">
                <button class="graph-btn" id="btn-zoom-in" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
                <button class="graph-btn" id="btn-zoom-out" title="–£–º–µ–Ω—å—à–∏—Ç—å">-</button>
                <button class="graph-btn" id="btn-reset" title="–°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—Ç—Ä">‚åÇ</button>
            </div>
        </div>
        
        <!-- Fixed Right-side Info Panel -->
        <div id="graph-info-panel" class="graph-info-panel">
            <div class="panel-placeholder">
                <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ —É–∑–µ–ª –≥—Ä–∞—Ñ–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Graph Visualization Logic -->
<script src="{% static 'js/ontology_graph.js' %}?v=1.4"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Fetch data from Django context
        const nodesData = [
            {% for concept in concepts %}
            {
                id: "{{ concept.id }}", 
                title: "{{ concept.title|escapejs }}",
                uri: "{{ concept.uri|escapejs }}",
                // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ URI –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ—á–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏–∑ –æ–Ω—Ç–æ–ª–æ–≥–∏–∏
                group: {% if 'Algo' in concept.uri %}1
                       {% elif 'Param' in concept.uri %}2
                       {% elif 'Metric' in concept.uri or 'Distance' in concept.uri %}3
                       {% elif 'UC' in concept.uri or 'UseCase' in concept.uri %}4
                       {% elif 'Geometry' in concept.uri %}5
                       {% elif 'Scalability' in concept.uri %}6
                       {% elif 'ClusterSize' in concept.uri or 'Size' in concept.uri %}7
                       {% elif 'Inference' in concept.uri or 'Inductive' in concept.uri or 'Transductive' in concept.uri %}8
                       {% else %}9{% endif %},
                url: "{% url 'encyclopedia:detail' concept.id %}",
                desc: "{{ concept.description|truncatewords:25|escapejs|default:'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}"
            },
            {% endfor %}
        ];

        const linksData = [
            {% for concept in concepts %}
                {% for rel in concept.relations_out.all %}
                {
                    source: "{{ concept.id }}", 
                    target: "{{ rel.target.id }}", 
                    type: "{{ rel.get_relation_type_display|escapejs }}",
                    raw_type: "{{ rel.relation_type|escapejs }}" // –ø–µ—Ä–µ–¥–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–∏–ø –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –ª–∏–Ω–∏–π
                },
                {% endfor %}
            {% endfor %}
        ];

        // 2. Initialize Graph from external JS file
        initOntologyGraph("ontology-graph", nodesData, linksData);
    });
</script>
{% endblock %}
