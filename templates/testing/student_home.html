{% extends 'base.html' %}
{% load static %}

{% block title %}Тестирование{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/testing.css' %}">
{% endblock %}

{% block content %}
<div class="testing-section testing-section--narrow">
  <h1>Тестирование</h1>

  <div class="testing-card">
    <h2>Подключиться к группе</h2>
    <p class="testing-card__meta--muted">Введите код, который дал преподаватель.</p>
    <form action="{% url 'testing:join_group' %}" method="post" class="testing-form-inline">
      {% csrf_token %}
      <input type="text" name="join_code" placeholder="Код группы" maxlength="16" required autocomplete="off">
      <button type="submit" class="btn btn-primary">Войти</button>
    </form>
  </div>

  {% if memberships %}
  <div class="testing-card">
    <h2>Мои группы</h2>
    <ul class="testing-list-plain">
      {% for m in memberships %}
      <li>{{ m.group.name }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="testing-card">
    <h2>Тесты по моим группам</h2>
    {% if tests_with_status %}
    <ul class="testing-list-tests">
      {% for item in tests_with_status %}
      <li>
        <div class="testing-list-tests__row">
          <strong>{{ item.test.title }}</strong> ({{ item.test.group.name }})<br>
          <span class="testing-list-tests__meta">
            Время: {{ item.test.time_limit_minutes }} мин.
            Окно: {{ item.test.opens_at|date:"d.m.Y H:i" }} — {{ item.test.closes_at|date:"d.m.Y H:i" }}
            {% if item.status == 'active' %}
              <span class="testing-status-badge testing-status-badge--active">Активен</span>
            {% elif item.status == 'future' %}
              <span class="testing-status-badge testing-status-badge--future">Скоро</span>
            {% else %}
              <span class="testing-status-badge testing-status-badge--past">Завершён</span>
            {% endif %}
          </span>
        </div>
        {% if item.status == 'active' %}
        <a href="{% url 'testing:start_test' item.test.pk %}" class="btn btn-primary">Начать</a>
        {% elif item.status == 'future' %}
        <span class="testing-card__meta--muted">Доступен с {{ item.test.opens_at|date:"d.m.Y H:i" }}</span>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="testing-card__meta--muted">Нет тестов. Подключитесь к группе по коду — после этого здесь появятся тесты преподавателя.</p>
    {% endif %}
  </div>

  {% if attempts_with_progress %}
  <div class="testing-card">
    <h2>Мои попытки</h2>
    <ul class="testing-list-tests">
      {% for item in attempts_with_progress %}
      <li>
        <div class="testing-list-tests__row">
          <strong>{{ item.attempt.test.title }}</strong><br>
          <span class="testing-list-tests__meta">
            {% if item.attempt.submitted_at %}
              Сдан {{ item.attempt.submitted_at|date:"d.m.Y H:i" }}
            {% else %}
              В процессе
            {% endif %}
            — <strong>{{ item.progress.attempted }}/{{ item.progress.total }} ({{ item.progress.percent }}%)</strong>
          </span>
        </div>
        {% if item.attempt.submitted_at %}
        <a href="{% url 'testing:attempt_result' item.attempt.pk %}" class="btn btn-outline">Результат</a>
        {% else %}
        <a href="{% url 'testing:take_test' item.attempt.pk %}" class="btn btn-outline">Продолжить</a>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>
{% endblock %}
